<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>South African Budget Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px #c7d2fe; /* indigo-200 */
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* slate-300 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .currency-prefix {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b; /* slate-500 */
        }
        .amount-input {
            padding-left: 2.5rem;
            text-align: right;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Personal Budget Calculator</h1>
            <p class="text-slate-500 mt-1">Manage your savings, debts, and future costs in ZAR.</p>
        </header>

        <!-- Main Layout with Sidebar -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Sidebar: Server Status -->
            <div class="lg:col-span-1">
                <div class="card bg-gradient-to-b from-blue-50 to-indigo-50 border-l-4 border-blue-400 sticky top-8">
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6"></path><path d="M21 12h-6m-6 0H3"></path></svg>
                            <div>
                                <h3 class="font-semibold text-blue-800">Server Status</h3>
                                <p class="text-sm text-blue-600">Local Database</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-600">Server:</span>
                                <span id="server-status" class="text-sm px-2 py-1 rounded-full bg-green-100 text-green-700 font-medium">Running</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-600">Database:</span>
                                <span id="db-status" class="text-sm px-2 py-1 rounded-full bg-green-100 text-green-700">Connected</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-600">Port:</span>
                                <span class="text-sm text-slate-800 font-medium">8000</span>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2 pt-2 border-t border-blue-200">
                            <button id="copy-url" class="btn btn-secondary text-xs w-full">Copy URL</button>
                            <button id="show-instructions" class="btn btn-secondary text-xs w-full">Server Help</button>
                        </div>

                        <!-- Database Section -->
                        <div class="pt-4 border-t border-blue-200">
                            <div class="flex items-center gap-2 mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M3 15a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4z"></path><path d="M7 10l5 5 5-5"></path><path d="M12 15V3"></path></svg>
                                <span class="font-medium text-slate-700 text-sm">Database</span>
                            </div>
                            <div class="text-xs text-slate-600 mb-3">calulator_data.csv</div>
                            <button id="save-csv" class="btn btn-primary text-xs w-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-3">

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-2">
                <!-- Savings -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">Current Savings</h2>
                    <div class="relative">
                        <span class="currency-prefix">R</span>
                        <input type="number" id="savings" class="input-field amount-input text-2xl font-bold" placeholder="0.00">
                    </div>
                </div>

                <!-- Debts -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-800">Debts</h2>
                        <button id="add-debt" class="btn btn-secondary text-sm">+ Add Debt</button>
                    </div>
                    <div id="debt-list" class="space-y-3"></div>
                </div>

                <!-- Provisions -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-800">Provisions</h2>
                        <button id="add-provision" class="btn btn-secondary text-sm">+ Add Provision</button>
                    </div>
                    <div id="provision-list" class="space-y-3"></div>
                </div>

                <!-- Future Costs -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-800">Future Costs</h2>
                        <button id="add-future-cost" class="btn btn-secondary text-sm">+ Add Cost</button>
                    </div>
                    <div id="future-cost-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="lg:col-span-1">
                <div class="card sticky top-8">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">Financial Summary</h2>
                    
                    <div class="space-y-6">
                        <!-- Current Net Amount -->
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm font-medium text-slate-500">Current Net Amount</p>
                            <p id="current-net-amount" class="text-3xl font-bold text-green-600">R 0.00</p>
                            <p class="text-xs text-slate-400 mt-1">Savings - (Debts + Provisions)</p>
                        </div>

                        <!-- Future Net Amount -->
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <label for="future-date" class="text-sm font-medium text-slate-500">Future Net Amount by</label>
                            <input type="date" id="future-date" class="input-field w-full mt-1">
                            <p id="future-net-amount" class="text-3xl font-bold text-indigo-600 mt-2">R 0.00</p>
                            <p class="text-xs text-slate-400 mt-1">Current Net - Future Costs up to selected date</p>
                        </div>
                    </div>

                    <hr class="my-6">

                    <!-- Breakdown -->
                    <div>
                        <h3 class="font-semibold text-slate-700 mb-2">Breakdown</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total Savings:</span>
                                <span id="summary-savings" class="font-medium text-slate-800">R 0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total Debts:</span>
                                <span id="summary-debts" class="font-medium text-red-500">R 0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total Provisions:</span>
                                <span id="summary-provisions" class="font-medium text-orange-500">R 0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total Future Costs:</span>
                                <span id="summary-future-costs" class="font-medium text-blue-500">R 0.00</span>
                            </div>
                        </div>
                        
                        <!-- Monthly Savings Target -->
                        <div class="mt-4 pt-3 border-t border-slate-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-slate-600">Monthly Savings Needed:</span>
                                <span id="monthly-savings-target" class="text-sm font-bold text-purple-600">R 0.00</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">To reach future net amount by selected date</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let data = {
                savings: 0,
                debts: [],
                provisions: [],
                futureCosts: []
            };

            // --- DOM ELEMENTS ---
            const savingsInput = document.getElementById('savings');
            const debtList = document.getElementById('debt-list');
            const provisionList = document.getElementById('provision-list');
            const futureCostList = document.getElementById('future-cost-list');
            const futureDateInput = document.getElementById('future-date');
            
            const addDebtBtn = document.getElementById('add-debt');
            const addProvisionBtn = document.getElementById('add-provision');
            const addFutureCostBtn = document.getElementById('add-future-cost');
            
            const saveCsvBtn = document.getElementById('save-csv');
            const dbStatus = document.getElementById('db-status');
            const serverStatus = document.getElementById('server-status');
            const copyUrlBtn = document.getElementById('copy-url');
            const showInstructionsBtn = document.getElementById('show-instructions');

            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (value) => {
                const num = parseFloat(value) || 0;
                return `R ${num.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };
            
            const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // --- RENDERING LOGIC ---
            const renderAll = () => {
                savingsInput.value = data.savings || '';
                renderList(debtList, data.debts, createDebtItem);
                renderList(provisionList, data.provisions, createProvisionItem);
                renderList(futureCostList, data.futureCosts, createFutureCostItem);
                calculateAndDisplaySummary();
            };

            const renderList = (container, items, createItemFn) => {
                container.innerHTML = '';
                if (items.length === 0) {
                    container.innerHTML = `<p class="text-sm text-slate-400 text-center py-2">No items added yet.</p>`;
                } else {
                    items.forEach(item => container.appendChild(createItemFn(item)));
                }
            };

            const createGenericItem = (item, hasDate = false) => {
                const div = document.createElement('div');
                div.className = 'grid gap-2 items-center';
                div.style.gridTemplateColumns = hasDate ? '1fr 1fr 1fr auto' : '1fr 1fr auto';
                div.dataset.id = item.id;

                // Description Input
                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.value = item.description;
                descInput.placeholder = 'Description';
                descInput.className = 'input-field description-input';
                
                // Amount Input
                const amountDiv = document.createElement('div');
                amountDiv.className = 'relative';
                const amountPrefix = document.createElement('span');
                amountPrefix.className = 'currency-prefix';
                amountPrefix.textContent = 'R';
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.value = item.amount;
                amountInput.placeholder = '0.00';
                amountInput.className = 'input-field amount-input';
                amountDiv.append(amountPrefix, amountInput);

                div.appendChild(descInput);
                div.appendChild(amountDiv);

                // Date Input (if applicable)
                if (hasDate) {
                    const dateInput = document.createElement('input');
                    dateInput.type = 'date';
                    dateInput.value = item.date || '';
                    dateInput.className = 'input-field date-input';
                    div.appendChild(dateInput);
                }

                // Remove Button
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                removeBtn.className = 'btn btn-danger remove-btn p-2';
                div.appendChild(removeBtn);

                return div;
            };
            
            const createDebtItem = (item) => createGenericItem(item, false);
            const createProvisionItem = (item) => createGenericItem(item, true);
            const createFutureCostItem = (item) => createGenericItem(item, true);

            // --- CALCULATION LOGIC ---
            const calculateAndDisplaySummary = () => {
                const totalDebts = data.debts.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                const totalProvisions = data.provisions.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                const totalFutureCosts = data.futureCosts.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                const savings = parseFloat(data.savings) || 0;

                const currentNetAmount = savings - totalDebts - totalProvisions;

                const futureDate = futureDateInput.value ? new Date(futureDateInput.value) : null;
                const relevantFutureCosts = futureDate 
                    ? data.futureCosts.reduce((sum, item) => {
                        const itemDate = item.date ? new Date(item.date) : null;
                        if (itemDate && itemDate <= futureDate) {
                            return sum + (parseFloat(item.amount) || 0);
                        }
                        return sum;
                    }, 0)
                    : 0;
                
                const futureNetAmount = currentNetAmount - relevantFutureCosts;

                // Update UI
                document.getElementById('current-net-amount').textContent = formatCurrency(currentNetAmount);
                document.getElementById('current-net-amount').style.color = currentNetAmount >= 0 ? '#16a34a' : '#ef4444'; // green-600 or red-500
                
                document.getElementById('future-net-amount').textContent = formatCurrency(futureNetAmount);
                document.getElementById('future-net-amount').style.color = futureNetAmount >= 0 ? '#4f46e5' : '#ef4444'; // indigo-600 or red-500

                document.getElementById('summary-savings').textContent = formatCurrency(savings);
                document.getElementById('summary-debts').textContent = `- ${formatCurrency(totalDebts)}`;
                document.getElementById('summary-provisions').textContent = `- ${formatCurrency(totalProvisions)}`;
                document.getElementById('summary-future-costs').textContent = formatCurrency(totalFutureCosts);

                // Calculate monthly savings target
                let monthlySavingsTarget = 0;
                if (futureDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate calculation
                    const targetDate = new Date(futureDate);
                    targetDate.setHours(0, 0, 0, 0);
                    
                    const timeDiff = targetDate - today;
                    const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                    const monthsDiff = Math.max(1, Math.ceil(daysDiff / 30)); // At least 1 month for calculation
                    
                    if (daysDiff > 0) {
                        // Calculate what we need to save to maintain or improve our financial position
                        if (futureNetAmount < 0) {
                            // We're in debt by the future date, need to save to get out
                            monthlySavingsTarget = Math.abs(futureNetAmount) / monthsDiff;
                        } else if (futureNetAmount < currentNetAmount) {
                            // We're losing money, need to save to maintain current position
                            monthlySavingsTarget = (currentNetAmount - futureNetAmount) / monthsDiff;
                        } else if (currentNetAmount < 0 && futureNetAmount >= 0) {
                            // We're currently in debt but will be positive by the future date
                            // Calculate how much we need to save to get to zero, then to the target
                            monthlySavingsTarget = (Math.abs(currentNetAmount) + futureNetAmount) / monthsDiff;
                        }
                        // If futureNetAmount >= currentNetAmount and both positive, no additional savings needed
                    }
                }
                
                document.getElementById('monthly-savings-target').textContent = formatCurrency(monthlySavingsTarget);
                document.getElementById('monthly-savings-target').style.color = monthlySavingsTarget > 0 ? '#7c3aed' : '#64748b'; // purple-600 or slate-500
            };

            // --- EVENT HANDLERS ---
            const handleListChange = (e, list) => {
                const target = e.target;
                const itemDiv = target.closest('[data-id]');
                if (!itemDiv) return;

                const id = itemDiv.dataset.id;
                const item = list.find(i => i.id === id);
                if (!item) return;

                if (target.classList.contains('remove-btn')) {
                    const index = list.findIndex(i => i.id === id);
                    if (index > -1) {
                        list.splice(index, 1);
                        renderAll();
                    }
                } else if (target.classList.contains('description-input')) {
                    item.description = target.value;
                } else if (target.classList.contains('amount-input')) {
                    item.amount = target.value;
                } else if (target.classList.contains('date-input')) {
                    item.date = target.value;
                }
                calculateAndDisplaySummary();
            };
            
            addDebtBtn.addEventListener('click', () => {
                data.debts.push({ id: generateId(), description: '', amount: '' });
                renderAll();
            });
            
            addProvisionBtn.addEventListener('click', () => {
                data.provisions.push({ id: generateId(), description: '', amount: '', date: '' });
                renderAll();
            });
            
            addFutureCostBtn.addEventListener('click', () => {
                data.futureCosts.push({ id: generateId(), description: '', amount: '', date: '' });
                renderAll();
            });

            savingsInput.addEventListener('input', (e) => {
                data.savings = e.target.value;
                calculateAndDisplaySummary();
            });
            
            futureDateInput.addEventListener('input', calculateAndDisplaySummary);

            debtList.addEventListener('input', (e) => handleListChange(e, data.debts));
            provisionList.addEventListener('input', (e) => handleListChange(e, data.provisions));
            futureCostList.addEventListener('input', (e) => handleListChange(e, data.futureCosts));
            
            debtList.addEventListener('click', (e) => handleListChange(e, data.debts));
            provisionList.addEventListener('click', (e) => handleListChange(e, data.provisions));
            futureCostList.addEventListener('click', (e) => handleListChange(e, data.futureCosts));

            // --- CSV HANDLING ---
            const parseCSV = (text) => {
                const newData = { savings: 0, debts: [], provisions: [], futureCosts: [] };
                const rows = text.split('\n').filter(row => row.trim() !== '');
                const contentRows = rows.slice(1); // Skip header

                contentRows.forEach(row => {
                    const [type, description, amount, date] = row.split(',').map(s => s.trim());
                    const item = { id: generateId(), description, amount: parseFloat(amount) || 0, date };
                    
                    switch (type) {
                        case 'savings':
                            newData.savings = parseFloat(amount) || 0;
                            break;
                        case 'debt':
                            newData.debts.push(item);
                            break;
                        case 'provision':
                            newData.provisions.push(item);
                            break;
                        case 'costfuturecost':
                            newData.futureCosts.push(item);
                            break;
                    }
                });
                return newData;
            };
            
            const generateCSV = () => {
                const header = 'type,description,amount,date\n';
                let csvContent = header;

                csvContent += `savings,,${data.savings || 0},\n`;
                data.debts.forEach(d => csvContent += `debt,${d.description || ''},${d.amount || 0},\n`);
                data.provisions.forEach(p => csvContent += `provision,${p.description || ''},${p.amount || 0},${p.date || ''}\n`);
                data.futureCosts.forEach(c => csvContent += `costfuturecost,${c.description || ''},${c.amount || 0},${c.date || ''}\n`);
                
                return csvContent;
            };

            // File System Access API support for saving to the same CSV without download
            let csvFileHandle = null;
            const saveToSameCSVFile = async () => {
                const csvData = generateCSV();
                try {
                    // Request file handle if we don't have one yet
                    if (!csvFileHandle) {
                        if (!window.showOpenFilePicker) {
                            alert('Direct file saving is not supported in this browser. Please use Chrome/Edge.');
                            return;
                        }
                        
                        try {
                            const [handle] = await window.showOpenFilePicker({
                                multiple: false,
                                types: [
                                    {
                                        description: 'CSV Files',
                                        accept: { 'text/csv': ['.csv'] }
                                    }
                                ],
                                excludeAcceptAllOption: false
                            });
                            csvFileHandle = handle;
                            console.log('File handle obtained successfully');
                        } catch (pickerErr) {
                            console.error('File picker error:', pickerErr);
                            alert('Please select calulator_data.csv to enable saving.');
                            return;
                        }
                    }

                    // Verify we can write
                    const permission = await csvFileHandle.queryPermission({ mode: 'readwrite' });
                    if (permission !== 'granted') {
                        const request = await csvFileHandle.requestPermission({ mode: 'readwrite' });
                        if (request !== 'granted') {
                            alert('Permission denied to write to the CSV file.');
                            return;
                        }
                    }

                    const writable = await csvFileHandle.createWritable();
                    await writable.write(csvData);
                    await writable.close();
                    
                    // Show success feedback
                    const saveBtn = document.getElementById('save-csv');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>Saved!';
                    saveBtn.className = 'btn text-xs w-full bg-green-600 hover:bg-green-700 text-white';
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.className = 'btn btn-primary text-xs w-full';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to save CSV:', err);
                    alert('Could not save to the CSV file. Please ensure you have write access to calulator_data.csv.');
                }
            };

            saveCsvBtn.addEventListener('click', () => {
                // Save directly to the same file (no download) using File System Access API
                saveToSameCSVFile();
            });

            // Server control panel event handlers
            copyUrlBtn.addEventListener('click', () => {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    copyUrlBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyUrlBtn.textContent = 'Copy URL';
                    }, 2000);
                }).catch(() => {
                    alert('Could not copy URL. Please copy manually: ' + url);
                });
            });

            showInstructionsBtn.addEventListener('click', () => {
                const instructions = `
ðŸš€ SERVER INSTRUCTIONS

START SERVER:
â€¢ Open Terminal/Command Prompt
â€¢ Navigate to project folder: cd /Users/sanderwiersma/Documents/dev_projects/budget_calculator
â€¢ Run: python3 -m http.server 8000
â€¢ Or: npx http-server -p 8000

STOP SERVER:
â€¢ Press Ctrl+C in the terminal

ACCESS APP:
â€¢ Open browser to: http://localhost:8000/budget_calculator.html

ALTERNATIVE SERVERS:
â€¢ Node.js: npx http-server -p 8000
â€¢ PHP: php -S localhost:8000
â€¢ Python 2: python -m SimpleHTTPServer 8000

The server must be running for the database to work!
                `;
                alert(instructions);
            });

            // --- INITIALIZATION ---
            const initializeEmptyState = () => {
                // Set data to a clean, empty state.
                data = {
                    savings: '',
                    debts: [],
                    provisions: [],
                    futureCosts: []
                };
                
                // Set the future date input to 6 months from today's date by default.
                const today = new Date();
                const sixMonthsFromToday = new Date(today);
                sixMonthsFromToday.setMonth(sixMonthsFromToday.getMonth() + 6);
                const yyyy = sixMonthsFromToday.getFullYear();
                const mm = String(sixMonthsFromToday.getMonth() + 1).padStart(2, '0');
                const dd = String(sixMonthsFromToday.getDate()).padStart(2, '0');
                futureDateInput.value = `${yyyy}-${mm}-${dd}`;

                // Render the empty state. The user will then load their CSV.
                renderAll();
            };

            // Attempt to automatically load default CSV from the same directory
            const loadDatabase = async () => {
                try {
                    // Load from project root
                    const response = await fetch('/calulator_data.csv', { cache: 'no-store' });
                    if (!response.ok) {
                        dbStatus.textContent = 'Not Found';
                        dbStatus.className = 'text-sm px-2 py-1 rounded-full bg-red-100 text-red-700';
                        serverStatus.textContent = 'Server Error';
                        serverStatus.className = 'text-sm px-2 py-1 rounded-full bg-red-100 text-red-700 font-medium';
                        return; // Keep empty state if missing
                    }
                    const text = await response.text();
                    data = parseCSV(text);
                    renderAll();
                    dbStatus.textContent = 'Loaded';
                    dbStatus.className = 'text-sm px-2 py-1 rounded-full bg-green-100 text-green-700';
                    serverStatus.textContent = 'Running';
                    serverStatus.className = 'text-sm px-2 py-1 rounded-full bg-green-100 text-green-700 font-medium';
                    
                    // Note: File handle will be requested on first save attempt
                    console.log('Database loaded successfully');
                } catch (err) {
                    // Likely running from file:// or server has no CSV; ignore
                    console.warn('Could not auto-load calulator_data.csv:', err);
                    dbStatus.textContent = 'Error';
                    dbStatus.className = 'text-sm px-2 py-1 rounded-full bg-red-100 text-red-700';
                    serverStatus.textContent = 'Not Running';
                    serverStatus.className = 'text-sm px-2 py-1 rounded-full bg-red-100 text-red-700 font-medium';
                }
            };

            // Initialize with database load
            initializeEmptyState();
            loadDatabase();
        });
    </script>
</body>
</html>